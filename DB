image: php:latest
services:
    - mysql:latest
cache:
    paths:
    - vendor/

stages:
    - connect
    - test
    - deploy

variables:
    # Configure mysql service (https://hub.docker.com/_/mysql/)
    MYSQL_DATABASE: database
    MYSQL_USER: runner
    MYSQL_ROOT_PASSWORD: password
    MYSQL_PASSWORD: password
    
    before_script:
    - apt-get update -yqq
    - apt-get install git -yqq zlib1g-dev
    # Install mysql driver
    - docker-php-ext-install pdo_mysql zip
    # Install composer
    - curl -sS https://getcomposer.org/installer | php
    # Install all project dependencies
    - php composer.phar install

test:
    stage: test
    script:
        - cp .env.test .env
        # Install & enable Xdebug for code coverage reports
        - pecl install xdebug
        - docker-php-ext-enable xdebug
        - php bin/console doctrine:migrations:migrate -e test
        - php bin/console doctrine:fixture:load --no-interaction -e test
        - php composer.phar test-gitlab

deploy:
    stage: deploy
    script:
        - 'which ssh-agent || ( apt-get update -y && apt-get install openssh-client -y )'
        - eval $(ssh-agent -s)
        - ssh-add <(echo "$SSH_PRIVATE_KEY")
        - mkdir -p ~/.ssh
        - echo -e "Host *\n\tStrictHostKeyChecking no\n\n" > ~/.ssh/config